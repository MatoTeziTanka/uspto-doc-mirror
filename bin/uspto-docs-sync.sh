#!/bin/bash
# uspto-docs-sync.sh - Mirror USPTO Open Data Portal API documentation with change tracking
# Purpose: Fetch ODP Swagger specs + docs, detect changes, optionally record in knowledge graph
# Usage: ./uspto-docs-sync.sh [--force]
#
# Configuration via environment variables:
#   DOC_MIRROR_BASE  - Root directory of this tool (defaults to current directory)
#   GRAPH            - Path to a JSONL file for knowledge-graph integration.
#                      If unset, graph logging is skipped entirely.
#
# Created: 2026-02-03

set -uo pipefail

# === CONFIGURATION ===
BASE="${DOC_MIRROR_BASE:-.}"
TOOL_DIR="$BASE"
DATA_DIR="$TOOL_DIR/data/uspto"
LOG_DIR="$TOOL_DIR/logs"
GRAPH="${GRAPH:-}"
MANIFEST="$DATA_DIR/hashes.manifest"
CHANGELOG="$DATA_DIR/CHANGELOG.md"

# === USPTO ODP API Documentation Sources ===
# The ODP site is a JS SPA - pages render client-side, curl gets empty shells.
# Strategy: Mirror the OpenAPI/Swagger YAML specs (machine-readable, complete)
# plus the PEDS mapping PDF and Getting Started content.

# Raw Swagger specs from patent-dev/uspto-odp (community-maintained, USPTO-sourced)
SWAGGER_BASE="https://raw.githubusercontent.com/patent-dev/uspto-odp/main/swagger"

# USPTO direct docs
USPTO_DOCS_BASE="https://data.uspto.gov"

# Associative array: local_filename -> source_url
declare -A PAGES=(
    # OpenAPI/Swagger YAML specs (authoritative API definitions)
    ["swagger.yaml"]="${SWAGGER_BASE}/swagger.yaml"
    ["odp-common-base.yaml"]="${SWAGGER_BASE}/odp-common-base.yaml"
    ["trial-proceedings.yaml"]="${SWAGGER_BASE}/trial-proceedings.yaml"
    ["trial-decisions.yaml"]="${SWAGGER_BASE}/trial-decisions.yaml"
    ["trial-documents.yaml"]="${SWAGGER_BASE}/trial-documents.yaml"
    ["trial-appeal-decisions.yaml"]="${SWAGGER_BASE}/trial-appeal-decisions.yaml"
    ["trial-interferences.yaml"]="${SWAGGER_BASE}/trial-interferences.yaml"
    ["trial-common.yaml"]="${SWAGGER_BASE}/trial-common.yaml"
    # USPTO direct documents
    ["PEDS-to-ODP-API-Mapping.pdf"]="${USPTO_DOCS_BASE}/documents/documents/PEDS-to-ODP-API-Mapping.pdf"
    ["ODP-API-Query-Spec.pdf"]="https://raw.githubusercontent.com/patent-dev/uspto-odp/main/ODP-API-Query-Spec.pdf"
    # Getting started and syntax (attempt - may get JS shell)
    ["getting-started.html"]="${USPTO_DOCS_BASE}/apis/getting-started"
    ["api-syntax-examples.html"]="${USPTO_DOCS_BASE}/apis/api-syntax-examples"
)

# === FUNCTIONS ===

log() {
    local ts
    ts=$(date -u +%Y-%m-%dT%H:%M:%SZ)
    echo "[$ts] $*" | tee -a "$LOG_DIR/sync.log"
}

get_hash() {
    local file="$1"
    if [[ -f "$file" ]]; then
        sha256sum "$file" | cut -d' ' -f1
    else
        echo "NONE"
    fi
}

graph_change() {
    [[ -z "${GRAPH:-}" ]] && return 0

    local page="$1"
    local change_type="$2"
    local old_hash="$3"
    local new_hash="$4"

    local ts
    ts=$(date -u +%Y-%m-%dT%H:%M:%S.%6NZ)
    local date_part
    date_part=$(date +%Y-%m-%d)
    local safe_name="${page%.yaml}"
    safe_name="${safe_name%.pdf}"
    safe_name="${safe_name%.html}"
    local node_id="DOC-MIRROR-uspto-${safe_name}-${date_part}"

    echo "{\"id\": \"$node_id\", \"kind\": \"doc-mirror-change\", \"source\": \"uspto\", \"page\": \"$page\", \"change_type\": \"$change_type\", \"old_hash\": \"$old_hash\", \"new_hash\": \"$new_hash\", \"detected_at\": \"$ts\"}" >> "$GRAPH"

    log "GRAPHED: $node_id ($change_type)"
}

update_changelog() {
    local page="$1"
    local change_type="$2"
    local ts
    ts=$(date -u +%Y-%m-%dT%H:%M:%SZ)

    if [[ ! -f "$CHANGELOG" ]]; then
        cat > "$CHANGELOG" << 'HEADER'
# USPTO Open Data Portal Documentation Changelog
# Auto-generated by uspto-docs-sync.sh

HEADER
    fi

    echo "- [$ts] **$change_type**: $page" >> "$CHANGELOG"
}

fetch_page() {
    local page="$1"
    local url="$2"
    local dest="$DATA_DIR/$page"
    local tmp_file
    tmp_file=$(mktemp)

    if curl -sfL "$url" -o "$tmp_file" 2>/dev/null; then
        # Check if we got a JS shell instead of real content (< 1KB for YAML/PDF = suspect)
        local size
        size=$(wc -c < "$tmp_file")
        
        local old_hash
        old_hash=$(get_hash "$dest")
        local new_hash
        new_hash=$(sha256sum "$tmp_file" | cut -d' ' -f1)

        if [[ "$old_hash" == "NONE" ]]; then
            mv "$tmp_file" "$dest"
            log "NEW: $page (${size} bytes)"
            graph_change "$page" "new" "$old_hash" "$new_hash"
            update_changelog "$page" "NEW"
            echo "$page:$new_hash" >> "$MANIFEST.tmp"
            return 0
        elif [[ "$old_hash" != "$new_hash" ]]; then
            mv "$tmp_file" "$dest"
            log "MODIFIED: $page (${old_hash:0:8}... -> ${new_hash:0:8}...)"
            graph_change "$page" "modified" "$old_hash" "$new_hash"
            update_changelog "$page" "MODIFIED"
            echo "$page:$new_hash" >> "$MANIFEST.tmp"
            return 0
        else
            rm "$tmp_file"
            echo "$page:$new_hash" >> "$MANIFEST.tmp"
            return 1
        fi
    else
        log "FETCH FAILED: $page ($url)"
        rm -f "$tmp_file"
        local old_hash
        old_hash=$(get_hash "$dest")
        if [[ "$old_hash" != "NONE" ]]; then
            echo "$page:$old_hash" >> "$MANIFEST.tmp"
        fi
        return 2
    fi
}

# === MAIN ===

log "=== USPTO DOCS SYNC STARTED ==="

total=0
new_count=0
modified_count=0
unchanged_count=0
failed_count=0

rm -f "$MANIFEST.tmp"
touch "$MANIFEST.tmp"

for page in "${!PAGES[@]}"; do
    url="${PAGES[$page]}"
    ((total++))

    result=0
    fetch_page "$page" "$url" || result=$?

    case $result in
        0)
            # Check last log line to distinguish new vs modified
            if tail -1 "$LOG_DIR/sync.log" | grep -q "NEW:"; then
                ((new_count++))
            else
                ((modified_count++))
            fi
            ;;
        1)
            ((unchanged_count++))
            ;;
        2)
            ((failed_count++))
            ;;
    esac
done

mv "$MANIFEST.tmp" "$MANIFEST"

log "=== SYNC COMPLETE ==="
log "Total: $total | New: $new_count | Modified: $modified_count | Unchanged: $unchanged_count | Failed: $failed_count"

if [[ -n "${GRAPH:-}" ]]; then
    ts=$(date -u +%Y-%m-%dT%H:%M:%S.%6NZ)
    date_part=$(date +%Y-%m-%d)
    echo "{\"id\": \"DOC-SYNC-uspto-$date_part\", \"kind\": \"doc-sync-run\", \"source\": \"uspto\", \"total\": $total, \"new\": $new_count, \"modified\": $modified_count, \"unchanged\": $unchanged_count, \"failed\": $failed_count, \"timestamp\": \"$ts\"}" >> "$GRAPH"
    log "Sync run graphed: DOC-SYNC-uspto-$date_part"
fi

if [[ $failed_count -gt 0 ]]; then
    exit 1
elif [[ $((new_count + modified_count)) -gt 0 ]]; then
    exit 0
else
    exit 0
fi
